<?xml version="1.0" encoding="UTF-8"?>
<Module>
    <ModulePrefs title="ドコイク？お店検索" author="kawanet" title_url="http://www.kawa.net/" height="250" screenshot="http://www.doko.jp/search/images/common/search_roope.gif" thumbnail="http://www.doko.jp/favicon.ico">
        <Require feature="opensocial-0.8" />
        <Require feature="dynamic-height" />
        <Require feature="views" />
    </ModulePrefs>
    <Content type="html"><![CDATA[

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3/jquery.min.js"></script>
<script type="text/javascript" src="http://www.kawa.net/works/js/jkl/share/jkl-dumper.js"></script>
<script type="text/javascript"><!--
    var API_KEY = 'Rev18e560ff7196aa8f19942e37911b9b1aiewer';
    var keyword;
    var pagenum;
    var pagesize = 20;

    // 検索を開始する
    function start_search (btn) {
        var form = document.forms[0];
        if ( btn ) form = btn.form;
        keyword = form.kw.value;
        pagenum = 1;
        call_search(0);
    }

    // 検索する（ページ移動付）
    function call_search (offset) {
        if ( offset ) pagenum += offset;
        var container = document.getElementById('shop_list');
        empty_element( container );
        var url = 'http://api.doko.jp/v1/searchPOI.do?key='+API_KEY+'&format=json&callback=search_result&pagesize='+pagesize+'&keyword='+keyword+'&pagenum='+pagenum;
        now_loading();
        request_jsonp( url );
    }

    // メッセージ表示
    function disp_mess (mess) {
        var libload = document.getElementById('lib_message');
        var html = libload.innerHTML;
        var container = document.getElementById('shop_preview');
        container.innerHTML = html;
        var elem = container.getElementsByTagName('p')[0];
        $(elem).text( mess );
        adjust_height();
    }

    // ローディング表示
    function now_loading (url) {
        var container = document.getElementById('shop_preview');
        empty_element( container );
        var iframe = document.createElement('iframe');
        container.appendChild( iframe );
        iframe.frameborder = '0';
        iframe.scrolling = 'no';
        var libload = document.getElementById('lib_loading');
        var html = libload.innerHTML;
        html += '<style>body { margin:0; padding:0; width: 320px; height: 400px; overflow: hidden; }</style>';
        if ( url ) {
            html += '<script>setTimeout(function(){location.href="'+url+'";},1);</script>';
        }
        var src = "javascript:void(document.write('" + html + "'));";
        iframe.src = src;
        adjust_height();
    }

    // エレメントを空にする
    function empty_element (elem) {
        while( elem.childNodes.length ) {
            elem.removeChild( elem.lastChild );
        }
    }

    // JSONP リクエストを送信する
    function request_jsonp (url) {
        var elem = document.createElement('script');
        elem.setAttribute( 'type', 'text/javascript' );
        elem.setAttribute( 'charset', 'UTF-8' );
        var container = document.getElementById('shop_preview');
        container.appendChild( elem );
        elem.src = url;
    }

    // 検索結果コールバック関数
    function search_result (data) {
        if ( ! data ) return disp_mess( '現在、この機能はご利用いただけません。(ドコイク？Webサービス)' );
        if ( ! data.results ) return disp_mess( '現在、この機能はご利用いただけません。(ドコイク？Webサービス)' );
        if ( ! data.results.poi ) return disp_mess( '店舗情報が見つかりませんでした。' );
        if ( ! data.results.poi.length ) return disp_mess( '店舗情報が見つかりませんでした。' );
        var rpin = data.results.poi[0].code;
        if ( ! rpin ) return disp_mess( '店舗情報が見つかりませんでした。' );
        display_preview( rpin );
		save_last_rpin( rpin );
        update_list( data.results.poi );
    }

    // ブログパーツの表示
	function display_preview ( rpin ) {
        var url = 'http://map.doko.jp/blogparts/b/sc='+rpin+'/sz=2/';
        now_loading( url );
	}

    // ブログパーツの表示
	function save_last_rpin ( rpin ) {
		update_viewer_store( 'rpin', rpin );
	}

    // データを保存する
    function update_viewer_store ( key, value ) {
        var req = opensocial.newDataRequest();
        var viewer = opensocial.IdSpec.PersonId.VIEWER;
        req.add( req.newUpdatePersonAppDataRequest( viewer, key, value ), 'update1' );
        req.send();
    }

    // データを読み出す
    function fetch_viewer_store ( key, callok, callng ) {
        var req = opensocial.newDataRequest();
        var p = {};
        var viewer = opensocial.IdSpec.PersonId.VIEWER;
        p[ opensocial.IdSpec.Field.USER_ID ] = viewer;
        var ispc = opensocial.newIdSpec( p );

		// リクエスト毎の識別子を付ける
        var REQKEY_USER = 'userid1';
        var REQKEY_DATA = 'data1';
        req.add( req.newFetchPersonRequest( viewer ), REQKEY_USER );
        req.add( req.newFetchPersonAppDataRequest( ispc, [key] ), REQKEY_DATA );

		if ( ! callng ) callng = function() {};
        var func = function ( res ) {
			// viewerのユーザIDを取り出す
//          var viewid = res.get(REQKEY_USER).getData().getId();
			// ↑エラー処理なし、↓エラー処理あり
            if ( ! res ) return callng( res );
            var u1 = res.get(REQKEY_USER);
            if ( ! u1 ) return callng( res );
            var u2 = u1.getData();
            if ( ! u2 ) return callng( res );
            var viewid = u2.getId();
            if ( ! viewid ) return callng( res );

			// ユーザIDとキーを指定してデータを取り出す
//          var value = (res.get(REQKEY_DATA).getData())[viewid][key];
			// ↑エラー処理なし、↓エラー処理あり
            var d1 = res.get(REQKEY_DATA);
            if ( ! d1 ) return callng( res );
            var d2 = d1.getData();
            if ( ! d2 ) return callng( res );
            var d3 = d2[viewid];
            if ( ! d3 ) return callng( res );
            var value = d3[key];

			// 取り出した値だけを引数にしてOKコールバック関数を呼ぶ
			if ( callok ) callok( value );
        };
        req.send( func );
    }

	// ダンプする
	function dump ( data ) {
		if ( ! JKL ) return;
		if ( ! JKL.Dumper ) return;
        var dumper = new JKL.Dumper();
        data = dumper.dump( data );
		alert( data );
	}

    // 検索結果リストの表示
    function update_list (list) {
        var container = document.getElementById('shop_list');
        empty_element( container );
        var ul = document.createElement('ul');
        container.appendChild( ul );
        for( var i=0; i<list.length; i++ ) {
            var li = document.createElement('li');
            ul.appendChild( li );
            var shop = list[i];
            var txt = document.createTextNode( shop.name );
            li.appendChild( txt );
            var title = shop.name;
            if ( shop.address ) {
                shop.address.match( /^(東京都|[^ ]*?(道|府|県))/ );
                var pref = RegExp.$1;
                if ( pref ) title += '（'+pref+'）';
            }
            li.title = title;
            (function(){
                var rpin = shop.code;
                var onclick = function () {
                    display_preview( rpin );
					save_last_rpin( rpin );
                };
                $(li).bind( 'click', onclick );
            })();
        }

        if ( list.length == pagesize ) {
            var nextimg = document.createElement('img');
            container.appendChild( nextimg );
            nextimg.src = 'http://www.doko.jp/search/common/ads/img/skin_a_marker.gif';
            nextimg.title = 'Page '+(pagenum+1);
            var nextpage = function () {
                call_search(+1);
            };
            $(nextimg).bind( 'click', nextpage );
        }
    }

    function init_width () {
        var window_width  = $(document.body).width();
        var ava_width     = 160;
        var ava_height    = 400;
        var midnavi_width  = 250;
        var midnavi_offset =  10;
        var iframe_offset = $.browser.msie ? 21 : 5;
		var canvas_padding = 5;
        var canvas_addwid   = canvas_padding*3 + ava_width + midnavi_width;
        var gadget_min    = 441;
        var gadget_width  = window_width;

        var curview = gadgets.views.getCurrentView();  
        if ( curview.getName() == 'canvas' ) {
            if ( gadget_min+canvas_addwid < window_width ) {
                gadget_width = window_width - canvas_addwid;

                var dkelem = $('#midnavi_parts');
                dkelem.width( midnavi_width );
                dkelem.css('float','left');
                dkelem.css('margin-left',canvas_padding+'px');

                var avaelem = $('#apviaapps_parts');
                avaelem.width( ava_width );
                avaelem.height( ava_height );
                avaelem.css('border','1px solid red');
                avaelem.css('float','right');

                var canelem = $('#content_canvas');
				canelem.css('float','left');
				canelem.css('margin-left',canvas_padding+'px');
            } else {
                $('#midnavi_parts').html('');
                $('#apviaapps_parts').html('');
            }
        }
        if ( gadget_width < gadget_min ) {
            gadget_width = gadget_min
        }

        var preview_width = 320;
        var copy_width = 162;
        var submit_width = 40;
        $('#area_upper').width( gadget_width );
        $('#area_lower').width( gadget_width ).css('margin',canvas_padding+'px 0');
        $('#shop_preview').width( preview_width+iframe_offset );
        $('#info_area').width( gadget_width-preview_width-iframe_offset );
        $('#shop_list').width( gadget_width-preview_width-iframe_offset );
        $('#shop_form').width( gadget_width-copy_width );
        $('#input_kw').width( gadget_width-copy_width-submit_width-10 );
        $('#input_submit').width( submit_width );
        $('#copyright').width( copy_width );
    }

    // ガジェットの高さの調整
    function adjust_height () {
        setTimeout( call_adjust, 1 );
    }

    // ガジェットの高さの調整
    function call_adjust () {
        gadgets.window.adjustHeight();
    }

    // 初期化
    function window_onload () {
        init_width();
        disp_mess('お店を検索できます。');
		fetch_viewer_store( 'rpin', display_preview );
    }
    $(window_onload);
//--></script>
<style><!--
    body, img, table, tr, td, div, form, ul, iframe { margin: 0; padding: 0; border: 0; }
    li { margin: 0; padding: 0; list-style: none; }
    iframe { overflow: hidden; }
    #area_lower {
        clear: left;
    }
    #shop_preview {
        float: left;
    }
    #shop_preview p {
        margin: 1em 0;
        padding: 0;
    }
    #shop_preview iframe {
        width: 100%;
        height: 404px;
    }
    #info_area {
        height: 30px;
        float: left;
    }
    #info_area a {
        margin-left: 4px;
    }
    #shop_list {
        float: left;
    }
    #shop_list ul {
        overflow: hidden;
    }
    #shop_list li {
        height: 14px;
        padding: 1px 0 1px 1px;
        line-height: 16px;
        font-size: 11px;
        overflow: hidden;
        cursor: pointer;
    }
    #shop_list li:hover {
        color: red;
        background: yellow;
        text-decoration: underline;
    }
    #shop_list img {
        cursor: pointer;
        width: 16px;
        height: 15px;
        margin-top: 1px;
        float: right;
    }
    #shop_form {
        float: left;
    }
    #copyright {
        float: left;
    }
    #copyright img {
        margin-top: 12px;
    }
    .elem_library {
        display: none;
    }
--></style>

<div id="content_all">
<div id="content_canvas">
<form onSubmit="start_search(); return false;">

<div id="area_upper">
    <div id="shop_preview"></div>
    <div id="info_area"></div>
    <div id="shop_list"></div>
</div>

<div id="area_lower">
    <div id="shop_form">
    <input id="input_kw" type="text" name="kw" value="">
    <input id="input_submit" type="button" value="検索" onClick="start_search(this);">
    </div>

    <div id="copyright">
    <img src="https://www.recruit.co.jp/corporate/shared/crrecruit2.gif">
    </div>
</div>

</form>

</div>
<div id="midnavi_parts"></div>
<div id="apviaapps_parts"></div>
</div>

<div class="elem_library" id="lib_loading">
<a target="_blank" href="http://www.doko.jp/"><img src="http://map.doko.jp/blogparts/images/header2.gif" alt="ドコイク？" title="ドコイク？" border="0"></a>
<img class="nowloading" src="http://www.doko.jp/search/images/ajax_loading.gif" alt="LOADING..." title="LOADING..." style="width: 189px; height: 111px; margin: 130px 66px 0px 65px;">
</div>

<div class="elem_library" id="lib_message">
<a target="_blank" href="http://www.doko.jp/"><img src="http://map.doko.jp/blogparts/images/header2.gif" alt="ドコイク？" title="ドコイク？" border="0"></a>
<p>&nbsp;</p>
</div>

</div>

    ]]></Content>
</Module>
