<?xml version="1.0" encoding="UTF-8"?>
<Module>
    <ModulePrefs title="ドコイク？お店検索" author="kawanet" title_url="http://www.kawa.net/" height="250" screenshot="http://www.doko.jp/search/images/common/search_roope.gif" thumbnail="http://www.doko.jp/favicon.ico">
        <Require feature="dynamic-height" />
    </ModulePrefs>
    <Content type="html"><![CDATA[

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3/jquery.min.js"></script>
<script type="text/javascript"><!--
    var API_KEY = 'Rev18e560ff7196aa8f19942e37911b9b1aiewer';
    var keyword;
    var pagenum;
    var pagesize = 20;

    // 検索を開始する
    function start_search (btn) {
        var form = document.forms[0];
        if ( btn ) form = btn.form;
        keyword = form.kw.value;
        pagenum = 1;
        call_search(0);
    }

    // 検索する（ページ移動付）
    function call_search (offset) {
        if ( offset ) pagenum += offset;
        var container = document.getElementById('shop_list');
        empty_element( container );
        var url = 'http://api.doko.jp/v1/searchPOI.do?key='+API_KEY+'&format=json&callback=search_result&pagesize='+pagesize+'&keyword='+keyword+'&pagenum='+pagenum;
        now_loading();
        request_jsonp( url );
    }

    // メッセージ表示
    function disp_mess (mess) {
        var libload = document.getElementById('lib_message');
        var html = libload.innerHTML;
        var container = document.getElementById('shop_preview');
        container.innerHTML = html;
        var elem = container.getElementsByTagName('p')[0];
        $(elem).text( mess );
        adjust_height();
    }

    // ローディング表示
    function now_loading (url) {
        var container = document.getElementById('shop_preview');
        empty_element( container );
        var iframe = document.createElement('iframe');
        container.appendChild( iframe );
        iframe.frameborder = '0';
        iframe.scrolling = 'no';
        var libload = document.getElementById('lib_loading');
        var html = libload.innerHTML;
        html += '<style>body { margin:0; padding:0; width: 320px; height: 400px; overflow: hidden; }</style>';
        if ( url ) {
            html += '<script>setTimeout(function(){location.href="'+url+'";},1);</script>';
        }
        var src = "javascript:void(document.write('" + html + "'));";
        iframe.src = src;
        adjust_height();
    }

    // エレメントを空にする
    function empty_element (elem) {
        while( elem.childNodes.length ) {
            elem.removeChild( elem.lastChild );
        }
    }

    // JSONP リクエストを送信する
    function request_jsonp (url) {
        var elem = document.createElement('script');
        elem.setAttribute( 'type', 'text/javascript' );
        elem.setAttribute( 'charset', 'UTF-8' );
        var container = document.getElementById('shop_preview');
        container.appendChild( elem );
        elem.src = url;
    }

    // 検索結果コールバック関数
    function search_result (data) {
        if ( ! data ) return disp_mess( '現在、この機能はご利用いただけません。(ドコイク？Webサービス)' );
        if ( ! data.results ) return disp_mess( '現在、この機能はご利用いただけません。(ドコイク？Webサービス)' );
        if ( ! data.results.poi ) return disp_mess( '店舗情報が見つかりませんでした。' );
        if ( ! data.results.poi.length ) return disp_mess( '店舗情報が見つかりませんでした。' );
        var code = data.results.poi[0].code;
        if ( ! code ) return disp_mess( '店舗情報が見つかりませんでした。' );
        update_preview( code );
        update_list( data.results.poi );
    }

    // ブログパーツの表示
    function update_preview (code) {
        var url = 'http://map.doko.jp/blogparts/b/sc='+code+'/sz=2/';
        now_loading( url );
    }

    // 検索結果リストの表示
    function update_list (list) {
        var container = document.getElementById('shop_list');
        empty_element( container );
        var ul = document.createElement('ul');
        container.appendChild( ul );
        for( var i=0; i<list.length; i++ ) {
            var li = document.createElement('li');
            ul.appendChild( li );
            var shop = list[i];
            var txt = document.createTextNode( shop.name );
            li.appendChild( txt );
            var title = shop.name;
            if ( shop.address ) {
                shop.address.match( /^(東京都|[^ ]*?(道|府|県))/ );
                var pref = RegExp.$1;
                if ( pref ) title += '（'+pref+'）';
            }
            li.title = title;
            (function(){
                var code = shop.code;
                var onclick = function () {
                    update_preview( code );
                };
                $(li).bind( 'click', onclick );
            })();
        }

        if ( list.length == pagesize ) {
            var nextimg = document.createElement('img');
            container.appendChild( nextimg );
            nextimg.src = 'http://www.doko.jp/search/common/ads/img/skin_a_marker.gif';
            nextimg.title = 'Page '+(pagenum+1);
            var nextpage = function () {
                call_search(+1);
            };
            $(nextimg).bind( 'click', nextpage );
        }
    }

    function init_width () {
        var gadget_width  = 441;
        var iframe_offset = $.browser.msie ? 21 : 5;
        var preview_width = 320;
        var copy_width = 162;
        var submit_width = 40;
        $('#area_upper').width( gadget_width );
        $('#area_lower').width( gadget_width );
        $('#shop_preview').width( preview_width+iframe_offset );
        $('#info_area').width( gadget_width-preview_width-iframe_offset );
        $('#shop_list').width( gadget_width-preview_width-iframe_offset );
        $('#shop_form').width( gadget_width-copy_width );
        $('#input_kw').width( gadget_width-copy_width-submit_width-10 );
        $('#input_submit').width( submit_width );
        $('#copyright').width( copy_width );
    }

    // ガジェットの高さの調整
    function adjust_height () {
        setTimeout( call_adjust, 1 );
    }

    // ガジェットの高さの調整
    function call_adjust () {
        gadgets.window.adjustHeight();
    }

    // 初期化
    function window_onload () {
        init_width();
        disp_mess('お店を検索できます。');
    }
    $(window_onload);
//--></script>
<style><!--
    body, img, table, tr, td, div, form, ul, iframe { margin: 0; padding: 0; border: 0; }
    li { margin: 0; padding: 0; list-style: none; }
    iframe { overflow: hidden; }
    #area_lower {
        clear: left;
        margin-bottom: 10px;
    }
    #shop_preview {
        float: left;
    }
    #shop_preview p {
        margin: 1em 0;
        padding: 0;
    }
    #shop_preview iframe {
        width: 100%;
        height: 404px;
    }
    #info_area {
        height: 30px;
        float: left;
    }
    #info_area a {
        margin-left: 4px;
    }
    #shop_list {
        float: left;
    }
    #shop_list ul {
        overflow: hidden;
    }
    #shop_list li {
        height: 14px;
        padding: 1px 0 1px 1px;
        line-height: 16px;
        font-size: 11px;
        overflow: hidden;
        cursor: pointer;
    }
    #shop_list li:hover {
        color: red;
        background: yellow;
        text-decoration: underline;
    }
    #shop_list img {
        cursor: pointer;
        width: 16px;
        height: 15px;
        margin-top: 1px;
        float: right;
    }
    #shop_form {
        float: left;
    }
    #copyright {
        float: left;
    }
    #copyright img {
        margin-top: 12px;
    }
    .elem_library {
        display: none;
    }
--></style>

<div id="all">
<div id="content_canvas">
<form onSubmit="start_search(); return false;">

<div id="area_upper">
    <div id="shop_preview"></div>
    <div id="info_area">
<!--
    <a target="_blank" href="http://www.doko.jp/search/auth/myPage/"><img src="http://www.doko.jp/search/images/btn_for_mydoko.gif"></a>
-->
    </div>
    <div id="shop_list"></div>
</div>

<div id="area_lower">
    <div id="shop_form">
    <input id="input_kw" type="text" name="kw" value="">
    <input id="input_submit" type="button" value="検索" onClick="start_search(this);">
    </div>

    <div id="copyright">
    <img src="https://www.recruit.co.jp/corporate/shared/crrecruit2.gif">
    </div>
</div>

</form>

</div>
<div id="apviaapps_parts"></div>
</div>

<div class="elem_library" id="lib_loading">
<a target="_blank" href="http://www.doko.jp/"><img src="http://map.doko.jp/blogparts/images/header2.gif" alt="ドコイク？" title="ドコイク？" border="0"></a>
<img class="nowloading" src="http://www.doko.jp/search/images/ajax_loading.gif" alt="LOADING..." title="LOADING..." style="width: 189px; height: 111px; margin: 130px 66px 0px 65px;">
</div>

<div class="elem_library" id="lib_message">
<a target="_blank" href="http://www.doko.jp/"><img src="http://map.doko.jp/blogparts/images/header2.gif" alt="ドコイク？" title="ドコイク？" border="0"></a>
<p>&nbsp;</p>
</div>

</div>

    ]]></Content>
</Module>
