<?xml version="1.0" encoding="UTF-8"?>
<Module>
    <ModulePrefs title="ドコイク？お店検索" author="kawanet" title_url="http://www.kawa.net/" height="250" screenshot="http://www.doko.jp/search/images/common/search_roope.gif" thumbnail="http://www.doko.jp/favicon.ico">
        <Require feature="opensocial-0.8" />
        <Require feature="dynamic-height" />
        <Require feature="views" />
    </ModulePrefs>
    <Content type="html"><![CDATA[

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3/jquery.min.js"></script>
<script type="text/javascript"><!--
    var API_KEY = 'Rev18e560ff7196aa8f19942e37911b9b1aiewer';
    var keyword;
    var pagenum;
    var pagesize = 20;

    // 検索を開始する
    function start_search (btn) {
        var form = document.forms[0];
        if ( btn ) form = btn.form;
        keyword = form.kw.value;
        pagenum = 1;
        call_search(0);
    }

    // 検索する（ページ移動付）
    function call_search (offset) {
        if ( offset ) pagenum += offset;
        var container = document.getElementById('shop_list');
        empty_element( container );
        var url = 'http://api.doko.jp/v1/searchPOI.do?key='+API_KEY+'&format=json&callback=search_result&pagesize='+pagesize+'&keyword='+keyword+'&pagenum='+pagenum;
        now_loading();
        request_jsonp( url );
    }

    // メッセージ表示
    function disp_mess (mess) {
        var libload = document.getElementById('lib_message');
        var html = libload.innerHTML;
        var container = document.getElementById('shop_preview');
        container.innerHTML = html;
        var elem = container.getElementsByTagName('p')[0];
        $(elem).text( mess );
        adjust_height();
    }

    // ローディング表示
    function now_loading (url) {
        var container = document.getElementById('shop_preview');
        empty_element( container );
        var iframe = document.createElement('iframe');
        container.appendChild( iframe );
        iframe.frameborder = '0';
        iframe.scrolling = 'no';
        var libload = document.getElementById('lib_loading');
        var html = libload.innerHTML;
        html += '<style>body { margin:0; padding:0; width: 320px; height: 400px; overflow: hidden; }</style>';
        if ( url ) {
            html += '<script>setTimeout(function(){location.href="'+url+'";},1);</script>';
        }
        var src = "javascript:void(document.write('" + html + "'));";
        iframe.src = src;
        adjust_height();
    }

    // エレメントを空にする
    function empty_element (elem) {
        while( elem.childNodes.length ) {
            elem.removeChild( elem.lastChild );
        }
    }

    // JSONP リクエストを送信する
    function request_jsonp (url) {
        var elem = document.createElement('script');
        elem.setAttribute( 'type', 'text/javascript' );
        elem.setAttribute( 'charset', 'UTF-8' );
        var container = document.getElementById('shop_preview');
        container.appendChild( elem );
        elem.src = url;
    }

    // 検索結果コールバック関数
    function search_result (data) {
        if ( ! data ) return disp_mess( '現在、この機能はご利用いただけません。(ドコイク？Webサービス)' );
        if ( ! data.results ) return disp_mess( '現在、この機能はご利用いただけません。(ドコイク？Webサービス)' );
        if ( ! data.results.poi ) return disp_mess( '店舗情報が見つかりませんでした。' );
        if ( ! data.results.poi.length ) return disp_mess( '店舗情報が見つかりませんでした。' );
        var rpin = data.results.poi[0].code;
        if ( ! rpin ) return disp_mess( '店舗情報が見つかりませんでした。' );
        display_preview( rpin );
        save_last_rpin( rpin );
        update_list( data.results.poi );
    }

    // ブログパーツの表示
    function display_preview ( rpin ) {
        var url = 'http://map.doko.jp/blogparts/b/sc='+rpin+'/sz=2/';
        now_loading( url );
    }

    // ブログパーツの表示
    function save_last_rpin ( rpin ) {
        update_viewer_store( 'rpin', rpin );
    }

    // viewerのデータを保存する関数
    function update_viewer_store ( key, value, callbk ) {
        var req = opensocial.newDataRequest();
        if ( window.mixi && mixi.newDataRequest ) req = mixi.newDataRequest();
        var viewer = opensocial.IdSpec.PersonId.VIEWER;
        var REQID_DATA = 'data1';
        req.add( req.newUpdatePersonAppDataRequest( viewer, key, value ), REQID_DATA );
        req.send( callbk );
    }

    // viewerのデータを読み出す関数
    function fetch_viewer_store ( key, callok, callng ) {
        var person = opensocial.IdSpec.PersonId.VIEWER;
        fetch_store( person, key, callok, callng );
    }

    // ownerのデータを読み出す関数
    function fetch_owner_store ( key, callok, callng ) {
        var person = opensocial.IdSpec.PersonId.OWNER;
        fetch_store( person, key, callok, callng );
    }

    // viewerのデータを読み出す関数
    function fetch_store ( person, key, callok, callng ) {
        var req = opensocial.newDataRequest();
        if ( window.mixi && mixi.newDataRequest ) req = mixi.newDataRequest();

        // ユーザID
        var p = {};
        var uidkey = opensocial.IdSpec.Field.USER_ID;
        p[uidkey] = person;
        var ispc = opensocial.newIdSpec( p );

        // リクエスト毎の識別子を付ける
        var REQID_USER = 'user1';
        var REQID_DATA = 'data1';
        req.add( req.newFetchPersonRequest( person ), REQID_USER );
        req.add( req.newFetchPersonAppDataRequest( ispc, [key] ), REQID_DATA );

        if ( ! callng ) callng = function() {};
        var func = function ( res ) {
            // personのユーザIDを取り出す
//          var viewid = res.get(REQID_USER).getData().getId();
            if ( ! res ) return callng( res );
            var u1 = res.get(REQID_USER);
            if ( ! u1 ) return callng( res );
            var u2 = u1.getData();
            if ( ! u2 ) return callng( res );
            var userid = u2.getId();
            if ( ! userid ) return callng( res );

            // ユーザIDとキーを指定してデータを取り出す
//          var value = (res.get(REQID_DATA).getData())[userid][key];
            var d1 = res.get(REQID_DATA);
            if ( ! d1 ) return callng( res );
            var d2 = d1.getData();
            if ( ! d2 ) return callng( res );
            var d3 = d2[userid];
            if ( ! d3 && d2[key] ) d3 = d2;     // bug?
            if ( ! d3 ) return callng( res );
            var value = d3[key];

            // 成功時は値を引数にしてOKコールバック関数を呼ぶ
            if ( callok ) callok( value );
        };
        req.send( func );
    }

    // 検索結果リストの表示
    function update_list (list) {
        var container = document.getElementById('shop_list');
        empty_element( container );
        var ul = document.createElement('ul');
        container.appendChild( ul );
        for( var i=0; i<list.length; i++ ) {
            var li = document.createElement('li');
            ul.appendChild( li );
            var shop = list[i];
            var txt = document.createTextNode( shop.name );
            li.appendChild( txt );
            var title = shop.name;
            if ( shop.address ) {
                shop.address.match( /^(東京都|[^ ]*?(道|府|県))/ );
                var pref = RegExp.$1;
                if ( pref ) title += '（'+pref+'）';
            }
            li.title = title;
            (function(){
                var rpin = shop.code;
                var onclick = function () {
                    display_preview( rpin );
                    save_last_rpin( rpin );
                };
                $(li).bind( 'click', onclick );
            })();
        }

        if ( list.length == pagesize ) {
            var nextimg = document.createElement('img');
            container.appendChild( nextimg );
            nextimg.src = 'http://www.doko.jp/search/common/ads/img/skin_a_marker.gif';
            nextimg.title = 'Page '+(pagenum+1);
            var nextpage = function () {
                call_search(+1);
            };
            $(nextimg).bind( 'click', nextpage );
        }
    }

    function init_width () {
        var window_width  = $(document.body).width();
        var gadget_width  = window_width;
        var canvas_padding = 5;
        var iframe_offset = $.browser.msie ? 21 : 5;
        var preview_width = 320;
        var copy_width = 162;
        var submit_width = 40;

        var curview = gadgets.views.getCurrentView();
        if ( curview.getName() == 'canvas' ) {
            var midnavi_width = $('#midnavi_parts').width();
            var ava_width = $('#apviaapps_parts').width();
            gadget_width = window_width - (canvas_padding*3 + ava_width + midnavi_width)-1;
		}

		$('#content_canvas').width( gadget_width );
        $('#shop_preview').width( preview_width+iframe_offset );
        $('#info_area').width( gadget_width-preview_width-iframe_offset );
        $('#shop_list').width( gadget_width-preview_width-iframe_offset );
        $('#shop_form').width( gadget_width-copy_width );
        $('#input_kw').width( gadget_width-copy_width-submit_width-10 );
        $('#input_submit').width( submit_width );
        $('#copyright').width( copy_width );
    }

    // ガジェットの高さの調整
    function adjust_height () {
        var func = function () {
            gadgets.window.adjustHeight();
        };
        setTimeout( func, 1 );
    }

    // 初期化
    function window_onload () {
        // ビューをスタイルシート(class)に反映(window.onload後)
        var curview = gadgets.views.getCurrentView();  
        $(document.body).addClass('view_'+curview.getName());

        // アプリの横幅に合わせて、div の幅を設定する
        init_width();

        // 初期メッセージを表示する
        disp_mess('お店を検索できます。');

        // アプリのオーナーの店舗検索履歴を表示する
        fetch_owner_store( 'rpin', display_preview );
    }
    $(window_onload);
//--></script>
<style><!--
    body, img, table, tr, td, div, form, ul, iframe { margin: 0; padding: 0; border: 0; }
    li { margin: 0; padding: 0; list-style: none; }
    iframe { overflow: hidden; }
    #area_lower {
        clear: left;
		margin: 5px 0;
    }
    #shop_preview {
        float: left;
    }
    #shop_preview p {
        margin: 1em 0;
        padding: 0;
    }
    #shop_preview iframe {
        width: 100%;
        height: 404px;
    }
    #info_area {
        height: 30px;
        float: left;
    }
    #info_area a {
        margin-left: 4px;
    }
    #shop_list {
        float: left;
    }
    #shop_list ul {
        overflow: hidden;
    }
    #shop_list li {
        height: 14px;
        padding: 1px 0 1px 1px;
        line-height: 16px;
        font-size: 11px;
        overflow: hidden;
        cursor: pointer;
    }
    #shop_list li:hover {
        color: red;
        background: yellow;
        text-decoration: underline;
    }
    #shop_list img {
        cursor: pointer;
        width: 16px;
        height: 15px;
        margin-top: 1px;
        float: right;
    }
    #shop_form {
        float: left;
    }
    #copyright {
        float: left;
    }
    #copyright img {
        margin-top: 12px;
    }
    .elem_library {
        display: none;
    }
    .view_canvas #content_canvas {
       	float: left;
		margin-left: 5px;
    }
    .view_canvas #midnavi_parts {
		width: 240px;
		height: 400px;
       	float: left;
		margin-left: 5px;
    }
    .view_canvas #apviaapps_parts {
		width: 160px;
		height: 400px;
       	float: right;
    }
    .view_home #apviaapps_parts, .view_profile #apviaapps_parts {
        display: none;
    }
    .view_home #midnavi_parts, .view_profile #midnavi_parts {
        display: none;
    }
--></style>

<div id="content_all">
<div id="content_canvas">
<form onSubmit="start_search(); return false;">

<div id="area_upper">
    <div id="shop_preview"></div>
    <div id="info_area"></div>
    <div id="shop_list"></div>
</div>

<div id="area_lower">
    <div id="shop_form">
    <input id="input_kw" type="text" name="kw" value="">
    <input id="input_submit" type="button" value="検索" onClick="start_search(this);">
    </div>

    <div id="copyright">
    <img src="https://www.recruit.co.jp/corporate/shared/crrecruit2.gif">
    </div>
</div>

</form>

</div>
<div id="midnavi_parts"></div>
<div id="apviaapps_parts"></div>
</div>

<div class="elem_library" id="lib_loading">
<a target="_blank" href="http://www.doko.jp/"><img src="http://map.doko.jp/blogparts/images/header2.gif" alt="ドコイク？" title="ドコイク？" border="0"></a>
<img class="nowloading" src="http://www.doko.jp/search/images/ajax_loading.gif" alt="LOADING..." title="LOADING..." style="width: 189px; height: 111px; margin: 130px 66px 0px 65px;">
</div>

<div class="elem_library" id="lib_message">
<a target="_blank" href="http://www.doko.jp/"><img src="http://map.doko.jp/blogparts/images/header2.gif" alt="ドコイク？" title="ドコイク？" border="0"></a>
<p>&nbsp;</p>
</div>

</div>

    ]]></Content>
</Module>
