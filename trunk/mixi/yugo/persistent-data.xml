<?xml version="1.0" encoding="UTF-8" ?>
<Module>
    <ModulePrefs title="persistent data">
        <Require feature="opensocial-0.8"/>
    </ModulePrefs>
    <Content type="html">
    <![CDATA[
        <div id="input">
            <FORM>
                var1: <INPUT TYPE="text" name="var1"/><br/>
                <INPUT TYPE="button" value="save" onclick="update( this.form )"/><br/>
                <INPUT TYPE="button" value="clear" onclick="clear_pd( this.form )"/>
            </FORM>
        </div>
        <h3>fetched persistent data:</h3>
        <div id="output"></div>
        <script type="text/javascript">
            var out = document.getElementById( 'output' );
            var cols = ['var1'];
            function update( form ) {
                out.innerHTML = 'updating...';
                var var1 = form.var1.value || '';
                // json object
                // request update
                var req = mixi.newDataRequest();
                //更新はVIWERにしかかけない
                req.add( req.newUpdatePersonAppDataRequest("VIEWER",cols, var1));
                req.send( update_callback );
            };
            function update_callback( res ) {
                if( res.hadError() ){
                    out.innerHTML = res.getErrorMessage();
                    return;
                }
                out.innerHTML = '<b>update success</b><br/>'; 
                fetch();
            };
            function fetch() {
                var req  = mixi.newDataRequest();
                req.add(req.newFetchPersonRequest("VIEWER"),"viewer");
                req.add(req.newFetchPersonAppDataRequest("VIEWER",cols ), "viewer_data");
                req.send( fetch_callback );
            };
            function fetch_callback( res ) {
                var vw  = res.get( "viewer" );
                me = vw.getData();
                var vwd = res.get("viewer_data");
                if(res.hadError()){
                    out.innerHTML = res.getErrorMessage();
                    return;
                }
                var data = ( vwd.getData() )[ me.getId() ];
                console.log(data);
                if( !data ){
                    out.innerHTML = 'persistent data is empty.';
                    return;
                }
                var var1 = data.var1 || 'blank';
                out.innerHTML = '<ul>'
                    + '<li>' + var1 + '</li>'
                    + '</ul>';
            };
            function clear_pd() {
                var req = mixi.newDataRequest();
                req.add( req.newRemovePersonAppDataRequest( opensocial.IdSpec.PersonId.VIEWER, cols ), "clear_data" );
                req.send( clear_callback );
            };
            function clear_callback( res ) {
                if( res.hadError() ){
                    out.innerHTML = res.getErrorMessage();
                    return;
                }
                out.innerHTML = '<b>clear success</b><br/>'; 
                fetch();
            };
            gadgets.util.registerOnLoadHandler( fetch );
        </script>
    ]]>
    </Content>
</Module>
